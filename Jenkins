pipeline {
    agent any
    tools {
        maven 'maven'
    }
    environment {
        SCANNER_HOME=tool 'sonar-scanner'
        
    }
    
    stages {
        stage('git clone') {
            steps {
                // Get some code from a GitHub repository
                git url: 'https://github.com/prateektiwary/java-maven-app.git', branch: 'main'
            }
        }
        stage("sonarqube analysis"){
           steps{
                withSonarQubeEnv("sonar-server"){     
                     sh " sonar-scanner \
                            -Dsonar.projectKey=jenkins \
                            -Dsonar.sources=. \
                            -Dsonar.host.url=http://34.27.16.28:9000 \
                            -Dsonar.login=sqp_fd027497522210783d83ef3f112ea060adaf9fed"
               }
        }
        }
        stage("maven build") {
            steps {
                script {
                    sh "mvn clean verify"
                } 
            }
        }
        stage('Build Docker Image') {
            steps {
                script {
                 sh "docker build -t us-docker.pkg.dev/oval-cyclist-426414-p0/myrepo/java2:latest ."
                 // sh "docker build -t olinapache ."
                }
            }
        }
        stage('Trivy Image scanning') {
            steps {
                script {
                 sh "trivy image us-docker.pkg.dev/oval-cyclist-426414-p0/myrepo/java2:latest "
                }
            }
        }
        // stage('Push Docker Image to docker') {
        //     steps {
        //         script {
        //             sh 'docker login -u prateek2024 -p dckr_pat_nc5upHgkg-PnA1X9QvIRBKzfxI4'
        //             sh 'docker push prateek2024/test:v1 '
        //             }
        //         }
        //  }
        stage('Authenticate to Artifact Registry') {
            steps {
                script {
                    // Authenticate Docker to GCR using the service account key
                    
                    sh 'gcloud auth configure-docker \
                        us-docker.pkg.dev'
                    //sh "gcloud auth configure-docker"
                }
            }
        }
        stage('Push Docker Image to Artifact Registry') {
             steps {
                script {
                    sh 'docker push us-docker.pkg.dev/oval-cyclist-426414-p0/myrepo/java2:latest '
                }
            }
        }
    }
    post {
        success {
            // Actions to take if the pipeline succeeds
            echo 'Pipeline succeeded!'
            // You can also send an email notification on success
            mail to: 'prateektiwary2024@gmail.com',
                 subject: "Pipeline Succeeded: ${currentBuild.fullDisplayName}",
                 body: "The pipeline ${env.BUILD_URL} has successfully completed."
        }
        failure {
            // Actions to take if the pipeline fails
            echo 'Pipeline failed!'
            // You can also send an email notification on failure
            mail to: 'prateektiwary2024@gmail.com',
                 subject: "Pipeline Failed: ${currentBuild.fullDisplayName}",
                 body: "The pipeline ${env.BUILD_URL} has failed. Check the logs for details."
        }
    }
}  


